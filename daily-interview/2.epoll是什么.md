### 想法-疑惑

### FQA --未必能解决

### 思路--学习过程

epoll_wait 主要做了以下操作：

1 检查 rdllist，如果不为空则去到 7，如果为空则去到 2

2. 设置 timeout
   3 开始无限循环
   4 设置线程状态为 TASK_INTERRUPTIBLE [参看 Sleeping in the Kernal](Kernel Korner - Sleeping in the Kernel)
   5 检查 rdllist 如果不为空去到 7， 否则去到 6
   6 调用 schedule_hrtimeout_range 睡到 timeout，中途有可能被 ep_poll_callback 唤醒回到 4，如果真的 timeout 则 break 去到 7
   7 设置线程状态为 TASK_RUNNING，rdllist 如果不为空时退出循环，否则继续循环
   8 调用 ep_send_events 将 rdllist 返回给用户态

### 摘要 --他山之石

![io ](https://upload-images.jianshu.io/upload_images/1837968-06cee0ab5d523727.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![why不引起阻塞](https://upload-images.jianshu.io/upload_images/1837968-c4be6ce0c264c8ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![同步和异步区别 在于io操作造成结果，原因呢？这个图看不出来](https://upload-images.jianshu.io/upload_images/1837968-3e717c53012e0f64.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![select read ](https://upload-images.jianshu.io/upload_images/1837968-3169c70996ee4e93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- shutdown

> close terminates both directions of data transfer, reading and writing. Since a TCP
> connection is full-duplex, there are times when we want to tell the other end that we
> have finished sending, even though that end might have more data to send u

- epoll

epoll 的特点

1 每次新建 IO 句柄(epoll_create)才复制并注册(epoll_register)到内核

2 内核根据 IO 事件，把准备好的 IO 句柄放到就绪队列

3 应用只要轮询(epoll_wait)就绪队列，然后去读取数据

只需要轮询就绪队列（数量少），不存在 select 的轮询，也没有内核的轮询，不需要多次复制所有的 IO 句柄。因此，可以同时支持的 IO 句柄数轻松过百万

### 参考书籍

- 6 章 215page UNIX Network Programming - The Sockets Networking
- 《Understanding the Linux Kernel, Third Edition》16.4 章

### 参考文章

- 如果这篇文章说不清 epoll 的本质，那就过来掐死我吧！
  https://zhuanlan.zhihu.com/p/64746509
- 源码
  https://zhuanlan.zhihu.com/p/56486633

- 线程 IO 模型介绍
  https://app.yinxiang.com/shard/s39/nl/8226829/746a982d-143e-4a14-a418-5bd092a890cd

- epoll
  https://app.yinxiang.com/shard/s39/nl/8226829/3f74aaa0-2762-4996-ac02-affa37d0029b
- aio - POSIX asynchronous I/O overview
  http://man7.org/linux/man-pages/man7/aio.7.html
  https://zhuanlan.zhihu.com/p/65007350
- 知乎
  https://www.zhihu.com/question/59975081/answer/
  https://zhuanlan.zhihu.com/p/38277885

- https://zhuanlan.zhihu.com/p/81549258
  多线程和多进程的区别（重点 必须从 cpu 调度，上下文切换，数据共享，多核 cup 利用率，资源占用，等等各方面回答，然后有一个问题必须会被问到：哪些东西是一个线程私有的？答案中必须包含寄存器，否则悲催）！
  线程所私有的：
  线程 id、寄存器的值、栈、线程的优先级和调度策略、线程的私有数据、信号屏蔽字、errno 变量、

如果这篇文章说不清 epoll 的本质，那就过来掐死我吧！ （2）

### 行动-分享
